!function(){window.ku=new function(){},ku._shared={},ku._shared.komapkey=function(e,n){return n[e]?ko.utils.unwrapObservable(n[e]):void 0},ku._shared._kucompile=function(e){var n=this;e||(e={}),e.fromko||ko.mapping.fromJS(n._kubase,n._komap,n._ku),ku.subscribeAll(n._ku,function(e,t,o,i){var u=_.reduce(i,function(e,n,t){return t+2>i.length?e:e instanceof Backbone.Model?e.get(n):e instanceof Backbone.Collection?e.at(n):e instanceof Array?e[n]:void 0},n),a=_.last(i);u.get(a)instanceof Backbone.Collection?u.get(a).set(ko.mapping.toJS(e),{merge:!0,fromko:!0}):u.set(a,e,{fromko:!0})},{overwrite:!!n._kuparent}),e.frombubble&&e.self||n.trigger("kububble",e)},ku._shared._kuupdate=function(e){var n=this;e||(e={});var t={};n instanceof ku.Collection&&(t=[]);var o="Model";n instanceof ku.Collection&&(o="Collection"),_.each(n.attributes||n.models||[],function(e,i){(e instanceof Backbone.Model||e instanceof Backbone.Collection)&&"undefined"==typeof e._kuparent&&(e._kuparent=n,e.trigger("kuupdate",{self:!0})),"Model"===o&&(t[i]=ku._extract(e)),"Collection"===o&&(t[i]=e.toJSON())}),n._kubase=t,n.trigger("kucompile")},ku._shared._kububble=function(e,n){n||(n={});var t=this;if(1==arguments.length)e instanceof Backbone.Model||e instanceof Backbone.Collection||(n=e,e=t),n.frombubble=t;else if(!(e instanceof Backbone.Model||e instanceof Backbone.Collection))throw"ku.bubble needs to be a backbone.model or collection";n||(n={}),n.frombubble=!0,"undefined"==typeof n.trail&&(n.trail=[]),n.trail.push(t),2==arguments.length&&t.trigger("kuupdate",n),t._kuparent?t._kuparent.trigger("kububble",e,n):t._ku.valueHasMutated()},ku.Model=Backbone.Model.extend({constructor:function(e,n){e||(e={}),n||(n={}),Backbone.Model.call(this,e,n);var t=this;n.collection&&(t._kuparent=n.collection),n.kuparent&&(t._kuparent=otps.kuparent),t._komap=n.komap||{},t._komap.key||(t._komap.key=ku._shared.komapkey.bind(null,t.idAttribute)),t._event_change=function(e,n){n||(n={}),_.each(t.attributes,function(e){e._kuparent==t}),t.trigger("kuupdate",n)},t.on("change",t._event_change),t.on("kuupdate",ku._shared._kuupdate.bind(t)),t.on("kucompile",ku._shared._kucompile.bind(t)),t.on("kububble",ku._shared._kububble.bind(t))},initialize:function(){var e=this;"undefined"==typeof e.get(e.idAttribute)&&e.set(e.idAttribute,e.cid),e._kubase=ko.observable({}),e._ku=ko.mapping.fromJS(e._kubase),e.trigger("kuupdate")}}),ku.Collection=Backbone.Collection.extend({model:ku.Model,constructor:function(e,n){var t=this;e||(e={}),n||(n={}),Backbone.Collection.call(t,e,n),n.kuparent&&(t._kuparent=otps.kuparent),this.cid=_.unique("c"),this._komap=n.komap||{},t._komap.key||(t._komap.key=ku._shared.komapkey.bind(null,t.idAttribute)),t._event_addremove=function(e,n,o){t.trigger("kuupdate",o)},t._event_reset=function(e,n){n.fromko||t.trigger("kuupdate",n)},t.on("add",t._event_addremove),t.on("remove",t._event_addremove),t.on("reset",t._event_reset),t.on("kuupdate",ku._shared._kuupdate.bind(t)),t.on("kucompile",ku._shared._kucompile.bind(t)),t.on("kububble",ku._shared._kububble.bind(t))},initialize:function(){var e=this;"undefined"==typeof e.get(e.idAttribute)&&e.set(e.idAttribute,e.cid),e._kubase=ko.observableArray([]),e._ku=ko.mapping.fromJS(e._kubase),e.trigger("kuupdate")}}),ku.applyBindings=function(e,n){ko.applyBindings(e._ku,n)},ku._extractRaw=function(e){return e instanceof ku.Model?e.attributes:e instanceof ku.Collection?e._ku:void 0},ku._extract=function(e){return"undefined"!=typeof e?e instanceof ku.Model?e._ku:e instanceof ku.Collection?e._ku:e instanceof Backbone.Model?ku._extract(e.attributes):e instanceof Backbone.Collection?_.map(e.models,ku._extract):"undefined"!=typeof e.__ko_proto__?ko.mapping.fromJS(e):e:void 0},ku.subscribeAll=function(e,n,t){t||(t={}),t.dispose=t.dispose||!1;var o=_.filter(_.keys(e.__ko_mapping__.mappedProperties),function(e){return!/__ko_mapping__/.test(e)});_.each(o,function(o){var i=[];o.match(/(\[[0-9]+\]|([^\[]*))/gi).forEach(function(e){if(/.+\..+/.test(e))e.split(".").forEach(function(e){e&&i.push(e)});else{var n=e.replace(/[\.\[\]]/g,"");n&&i.push(n)}});var u=_.reduce(i,function(e,n,t){if(t+2>i.length)return"function"==typeof e?e():e;if("function"==typeof e)return e()[n];if("undefined"!=typeof e[n])return e[n];throw"something went wrong. Send code and data samples to knockup on github."},e),a=_.last(i);if("undefined"!=typeof u&&"undefined"!=typeof u[a]&&"function"==typeof u[a]&&"undefined"!=typeof u[a].__ko_proto__){var r=!1;if(t.overwrite&&"undefined"!=typeof u[a]._subscriptions.change)u[a]._subscriptions.change=_.filter(u[a]._subscriptions.change,function(e){return!e._kusubscription});else if("undefined"!=typeof u[a]._subscriptions.change){if(r=_.reduce(u[a]._subscriptions.change,function(e,n){return e||n._kusubscription||!1},r))return}else u[a]._subscriptions.change=[];var c=new ko.subscription(u[a],function(e){n.call(t.bindto||this,e,this,o,i)},t.dispose);c._kusubscription=!0,u[a]._subscriptions.change.push(c)}})}}();