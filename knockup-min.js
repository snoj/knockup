(function(){"use strict";var e=window.ku=new function n(){};e._shared={};e._shared.komapkey=function(e,n){if(n[e])return ko.utils.unwrapObservable(n[e]);return};e._shared._kucompile=function(n){var t=this;n||(n={});if(!!!n.fromko||!!n.skipmap)ko.mapping.fromJS(t._kubase,t._komap,t._ku);e.subscribeAll(t._ku,function(e,n,i,o){var r=this;var a=_.reduce(o,function(e,n,t){if(t+2>o.length)return e;if(e instanceof Backbone.Model)return e.get(n);if(e instanceof Backbone.Collection)return e.at(n);if(e instanceof Array)return e[n]},t);var u=_.last(o);var f=a.get(u);if(f.toJSON)f=f.toJSON();if(_.isEqual(ko.mapping.toJS(e),f))return;if(a.get(u)instanceof Backbone.Collection)a.get(u).set(ko.mapping.toJS(e),{merge:true,fromko:true});else if(a.get(u))a.set(u,e,{fromko:true})},{overwrite:!!t._kuparent});if(!!!n.frombubble||!!!n.self)t.trigger("kububble",n)};e._shared._kuupdate=function(n){var t=this;n||(n={});var i={};if(t instanceof e.Collection){i=[]}var o="Model";if(t instanceof e.Collection)o="Collection";var r=t.attributes;var a=t.models;if(t instanceof e.Model){a=t.hasChanged()?t.changed:t.attributes}if(t instanceof e.Collection){a=t.hasChangedModels()?t.changedModels:t.models}_.each(n.values||r||t.models||[],function(n,r){if((n instanceof Backbone.Model||n instanceof Backbone.Collection)&&typeof n._kuparent==="undefined"){n._kuparent=t;n.trigger("kuupdate",{self:true})}if(o==="Model")i[r]=e._extract(n);if(o==="Collection")i[r]=n.toJSON()});t._kubase=i;t.trigger("kucompile")};e._shared._kububble=function(e,n){n||(n={});var t=this;if(arguments.length==1){if(!(e instanceof Backbone.Model||e instanceof Backbone.Collection)){n=e;e=t}n.frombubble=t}else if(!(e instanceof Backbone.Model||e instanceof Backbone.Collection)){throw"ku.bubble needs to be a backbone.model or collection"}n||(n={});n.frombubble=true;if(typeof n.trail=="undefined")n.trail=[];n.trail.push(t);if(arguments.length==2)t.trigger("kuupdate",n);if(t._kuparent)t._kuparent.trigger("kububble",e,n);else t._ku.valueHasMutated()};e.Model=Backbone.Model.extend({constructor:function(n,t){n||(n={});t||(t={});Backbone.Model.call(this,n,t);var i=this;if(t.collection)i._kuparent=t.collection;if(t.kuparent)i._kuparent=otps.kuparent;i._komap=t.komap||{};i._komap.key||(i._komap.key=e._shared.komapkey.bind(null,i.idAttribute));i._event_change=function(e,n){n||(n={});_.each(i.attributes,function(e){e._kuparent==i});i.trigger("kuupdate",n)};i.on("change",i._event_change);i.on("kuupdate",e._shared._kuupdate.bind(i));i.on("kucompile",e._shared._kucompile.bind(i));i.on("kububble",e._shared._kububble.bind(i))},initialize:function(n,t){var i=this;if(typeof i.get(i.idAttribute)==="undefined")i.set(i.idAttribute,i.cid);i._kubase=ko.observable({});i._ku=ko.mapping.fromJS(i._kubase);e._shared._kuupdate.call(i,{values:n})}});e.Collection=Backbone.Collection.extend({model:e.Model,constructor:function(n,t){var i=this;n||(n={});t||(t={});Backbone.Collection.call(i,n,t);if(t.kuparent)i._kuparent=otps.kuparent;this.cid=_.unique("c");this._komap=t.komap||{};i._komap.key||(i._komap.key=e._shared.komapkey.bind(null,i.idAttribute));i.changedModels=[];var o=function(e){var n=this;i.changedModels=_.filter(i.models,function(e){return e.hasChanged()})};i.hasChangedModels=function(){return i.changedModels.length>0};i._event_add=function(e,n,t){o(t);i.trigger("kuupdate",t)};i._event_remove=function(e,n,t){o(t);i.trigger("kuupdate",t)};i._event_reset=function(e,n){if(n.fromko)return;o(n);i.trigger("kuupdate",n)};i.on("add",i._event_add);i.on("remove",i._event_remove);i.on("reset",i._event_reset);i.on("kuupdate",e._shared._kuupdate.bind(i));i.on("kucompile",e._shared._kucompile.bind(i));i.on("kububble",e._shared._kububble.bind(i));i.on("kububble",function(e,n){o(n)})},initialize:function(e,n){var t=this;if(typeof t.get(t.idAttribute)==="undefined")t.set(t.idAttribute,t.cid);t._kubase=ko.observableArray([]);t._ku=ko.mapping.fromJS(t._kubase);t.trigger("kuupdate",{values:t.models})}});e.applyBindings=function(e,n){e.trigger("kuupdate");ko.applyBindings(e._ku,n)};e._extractRaw=function(n){if(n instanceof e.Model){return n.attributes}if(n instanceof e.Collection){return n._ku}};e._extract=function(n){if(typeof n==="undefined")return;if(n instanceof e.Model){return n._ku}if(n instanceof e.Collection){return n._ku}if(n instanceof Backbone.Model){return e._extract(n.attributes)}if(n instanceof Backbone.Collection){return _.map(n.models,e._extract)}if(typeof n.__ko_proto__!=="undefined")return ko.mapping.fromJS(n);else return n};e.subscribeAll=function(e,n,t){t||(t={});t.dispose=t.dispose||false;var i=_.filter(_.keys(e.__ko_mapping__.mappedProperties),function(e){return!/__ko_mapping__/.test(e)});t.id=t.id||"kusubscription";_.each(i,function(i){var o=e;var r=null;var a=[];i.match(/(\[[0-9]+\]|([^\[]*))/gi).forEach(function(e){if(/.+\..+/.test(e)){e.split(".").forEach(function(e){if(e)a.push(e)})}else{var n=e.replace(/[\.\[\]]/g,"");if(n)a.push(n)}});var u=_.reduce(a,function(e,n,t){if(t+2>a.length)return typeof e==="function"?e():e;if(typeof e==="function")return e()[n];else if(typeof e[n]!=="undefined")return e[n];else throw"something went wrong. Send code and data samples to knockup on github."},e);var f=_.last(a);if(typeof u==="undefined"||typeof u[f]==="undefined")return;if(typeof u[f]==="function"&&typeof u[f].__ko_proto__!=="undefined"){var s=false;if(t.overwrite&&typeof u[f]._subscriptions.change){u[f]._subscriptions.change=_.filter(u[f]._subscriptions.change,function(e,n){return!!!e[t.id]})}else if(typeof u[f]._subscriptions.change!=="undefined"){s=_.reduce(u[f]._subscriptions.change,function(e,n){return e||n[t.id]||false},s);if(s&&!!!t.notku)return}else{u[f]._subscriptions.change=[]}var c;var l=new ko.subscription(u[f],function(e){n.call(t.bindto||this,e,this,i,a)});if(!!!t.notku)l[t.id]=true;u[f]._subscriptions.change.push(l)}})};e.getKOKeys=function(e,n){n||(n={});n.map=typeof n.map==="undefined"?true:n.map;var t=_.filter(_.keys(e.__ko_mapping__.mappedProperties),function(e){return!/__ko_mapping__/.test(e)});return _.map(t,function(t){var i=[];t.match(/(\[[0-9]+\]|([^\[]*))/gi).forEach(function(e){if(/.+\..+/.test(e)){e.split(".").forEach(function(e){if(e)i.push(e)})}else{var n=e.replace(/[\.\[\]]/g,"");if(n)i.push(n)}});var o={fullpath:t,patharray:i};var r=_.reduce(i,function(e,n,t){if(t+2>i.length)return typeof e==="function"?e():e;if(typeof e==="function")return e()[n];else if(typeof e[n]!=="undefined")return e[n];else throw"something went wrong. Send code and data samples to knockup on github."},e);if(typeof r==="undefined"){return}else if(typeof r!=="undefined"&&n.map){o.ko=r;o.value=r[_.last(i)]}return o}).filter(function(e){return typeof e!=="undefined"})};e.mapBB=function(n,t){var i=e.getKOKeys(n);_.forEach(i,function(e){var n=_.reduce(e.patharray,function(n,t,i){if(i+2>e.patharray.length)return n;if(n instanceof Backbone.Model)return n.get(t);if(n instanceof Backbone.Collection)return n.at(t);if(n instanceof Array)return n[t]},t);if(typeof n!=="undefined"){e.bb=n}});return i};ko.observable["fn"].isDifferent=function(e,n){return!_.isEqual(e,n)}})();
//# sourceMappingURL=knockup-min.map